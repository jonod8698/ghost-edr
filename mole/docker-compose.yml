services:
  enforcer:
    build:
      context: ../enforcer
      dockerfile: Dockerfile
    container_name: ghost-enforcer

    volumes:
      - ../config/ghost-edr.yaml:/app/config.yaml:ro

    # Security hardening
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=10m

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          memory: 64M

    ports:
      - "8766:8766"

    command: ["run", "--config", "/app/config.yaml", "--port", "8766"]

    restart: unless-stopped

    labels:
      ghost-edr.component: "enforcer"
      ghost-edr.version: "1.0.0"

    depends_on:
      falco:
        condition: service_healthy

  falco:
    image: falcosecurity/falco:0.39.2
    container_name: ghost-mole
    privileged: true
    pid: host
    network_mode: host

    volumes:
      # Required for syscall monitoring
      - /var/run/docker.sock:/host/var/run/docker.sock:ro
      - /proc:/host/proc:ro
      - /etc:/host/etc:ro

      # eBPF support
      - /sys/kernel/tracing:/sys/kernel/tracing:ro
      - /sys/kernel/debug:/sys/kernel/debug:ro
      - /sys/kernel/btf:/sys/kernel/btf:ro
      - /sys/fs/bpf:/sys/fs/bpf

      # Custom configuration
      - ./config/falco.yaml:/etc/falco/falco.yaml:ro
      - ./config/rules:/etc/falco/rules.d:ro

    environment:
      - HOST_ROOT=/host
      - FALCO_BPF_PROBE=""

    command:
      - /usr/bin/falco
      - -o
      - engine.kind=modern_ebpf
      - -o
      - json_output=true
      - -o
      - json_include_output_property=true
      - -o
      - json_include_tags_property=true
      - -o
      - http_output.enabled=true
      - -o
      - http_output.url=http://host.docker.internal:8766/falco
      - -o
      - log_level=info

    healthcheck:
      test: ["CMD", "test", "-e", "/var/run/falco.pid"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    restart: unless-stopped

    labels:
      ghost-edr.component: "mole"
      ghost-edr.version: "1.0.0"
